name: Release Build (Multi-Platform)

# ============================================================================
# å¤šå¹³å°æž„å»ºè„šæœ¬
# 
# ä¸Ž KTM æœ¬åœ°æž„å»ºè„šæœ¬ä¿æŒä¸€è‡´ï¼š
# - macOS: build-macos-universal.shï¼ˆaarch64 + x64 DMGï¼‰
# - Windows: build-windows.batï¼ˆä¾¿æºç‰ˆ + å®‰è£…ç‰ˆï¼‰
# - Linux: Dockerfile.buildï¼ˆDEB + RPMï¼‰
# 
# æ¸ é“æ”¯æŒï¼š
# - default æ¸ é“ï¼štag æ ¼å¼ v0.2.8
# - goofish æ¸ é“ï¼štag æ ¼å¼ goofish-v0.2.8
# 
# é›†æˆä¿æŠ¤æŽªæ–½ï¼š
# - å‰ç«¯ä»£ç æ··æ·†ï¼ˆæŽ§åˆ¶æµæ‰å¹³åŒ–ã€å­—ç¬¦ä¸²åŠ å¯†ã€æ­»ä»£ç æ³¨å…¥ï¼‰
# - Rust LTO ä¼˜åŒ–å’Œç¬¦å·å‰¥ç¦»
# - è¿è¡Œæ—¶åè°ƒè¯•ï¼ˆptraceã€è°ƒè¯•å™¨æ£€æµ‹ã€å®Œæ•´æ€§æ£€æŸ¥ï¼‰
# - äºŒè¿›åˆ¶åŠ å£³ï¼ˆç¬¦å·å‰¥ç¦»ã€åžƒåœ¾æ•°æ®æ³¨å…¥ã€æ—¶é—´æˆ³æ··æ·†ï¼‰
# ============================================================================

on:
  push:
    tags:
      - 'v*'           # default æ¸ é“
      - 'goofish-v*'   # goofish æ¸ é“
  workflow_dispatch:
    inputs:
      channel:
        description: 'æž„å»ºæ¸ é“ (default/goofish)'
        required: false
        default: 'default'

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            arch: 'aarch64'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            arch: 'x64'
          - platform: 'ubuntu-22.04'
            target: 'x86_64-unknown-linux-gnu'
            arch: 'amd64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO }}
          token: ${{ secrets.PRIVATE_REPO_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libxdo-dev libssl-dev

      - name: Install dependencies
        run: npm ci

      - name: Determine channel and version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/goofish-v* ]]; then
            CHANNEL="goofish"
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#goofish-v}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            CHANNEL="default"
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            CHANNEL="${{ github.event.inputs.channel }}"
            CHANNEL="${CHANNEL:-default}"
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "CHANNEL=$CHANNEL" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Channel: $CHANNEL"
          echo "ðŸ“Œ Version: $VERSION"
          npm pkg set version="$VERSION"

      - name: Build frontend
        env:
          CHANNEL: ${{ steps.version.outputs.CHANNEL }}
        run: npm run build

      - name: Build Rust backend (non-Windows)
        if: matrix.platform != 'windows-latest'
        shell: bash
        env:
          CHANNEL: ${{ steps.version.outputs.CHANNEL }}
        run: |
          cd src-tauri
          cargo build --release --target ${{ matrix.target }}
          cd ..

      - name: Binary packing (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          BINARY_PATH="src-tauri/target/${{ matrix.target }}/release/kiro-token-manager"
          if [ -f "$BINARY_PATH" ]; then
            strip -x "$BINARY_PATH" 2>/dev/null || true
            strip -S "$BINARY_PATH" 2>/dev/null || true
            JUNK_FILE=$(mktemp)
            dd if=/dev/urandom of="$JUNK_FILE" bs=1024 count=256 2>/dev/null
            cat "$JUNK_FILE" >> "$BINARY_PATH"
            rm -f "$JUNK_FILE"
            touch -t 200001010000 "$BINARY_PATH" 2>/dev/null || true
          fi

      - name: Binary packing (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          BINARY_PATH="src-tauri/target/${{ matrix.target }}/release/kiro-token-manager"
          if [ -f "$BINARY_PATH" ]; then
            strip --strip-all "$BINARY_PATH" 2>/dev/null || true
            JUNK_FILE=$(mktemp)
            dd if=/dev/urandom of="$JUNK_FILE" bs=1024 count=256 2>/dev/null
            cat "$JUNK_FILE" >> "$BINARY_PATH"
            rm -f "$JUNK_FILE"
            touch -t 200001010000 "$BINARY_PATH" 2>/dev/null || true
          fi

      - name: Bundle Tauri app (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          CHANNEL: ${{ steps.version.outputs.CHANNEL }}
        run: npm run tauri build -- --target ${{ matrix.target }} --bundles dmg

      - name: Bundle Tauri app (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        env:
          CHANNEL: ${{ steps.version.outputs.CHANNEL }}
        run: npm run tauri build -- --target ${{ matrix.target }} --bundles deb,rpm

      - name: Bundle Tauri app (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        env:
          CHANNEL: ${{ steps.version.outputs.CHANNEL }}
        run: |
          # ä½¿ç”¨ tauri build ç”ŸæˆåŒ…å«åµŒå…¥å‰ç«¯èµ„æºçš„å¯æ‰§è¡Œæ–‡ä»¶
          npm run tauri build -- --target ${{ matrix.target }} --bundles nsis

      - name: Install UPX (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $upxVersion = "4.2.4"
          $upxUrl = "https://github.com/upx/upx/releases/download/v${upxVersion}/upx-${upxVersion}-win64.zip"
          Invoke-WebRequest -Uri $upxUrl -OutFile "upx.zip"
          Expand-Archive -Path "upx.zip" -DestinationPath "upx-temp" -Force
          Move-Item "upx-temp/upx-${upxVersion}-win64/upx.exe" "upx.exe"
          Remove-Item "upx.zip"
          Remove-Item "upx-temp" -Recurse

      - name: Binary packing (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $binaryPath = "src-tauri/target/${{ matrix.target }}/release/kiro-token-manager.exe"
          if (Test-Path $binaryPath) {
            # UPX åŽ‹ç¼©ï¼ˆtauri build ç”Ÿæˆçš„ exe å¯èƒ½æ— æ³•åŽ‹ç¼©ï¼Œå¿½ç•¥é”™è¯¯ï¼‰
            ./upx.exe --best --lzma $binaryPath 2>$null
            # æ·»åŠ åžƒåœ¾æ•°æ®æ··æ·†
            $junkData = New-Object byte[] 262144
            $rng = New-Object System.Security.Cryptography.RNGCryptoServiceProvider
            $rng.GetBytes($junkData)
            $fs = [System.IO.File]::Open($binaryPath, [System.IO.FileMode]::Append)
            $fs.Write($junkData, 0, $junkData.Length)
            $fs.Close()
            # ä¿®æ”¹æ—¶é—´æˆ³
            $fakeDate = Get-Date "2020-01-01 00:00:00"
            (Get-Item $binaryPath).CreationTime = $fakeDate
            (Get-Item $binaryPath).LastWriteTime = $fakeDate
          }

      - name: Create Windows portable packages
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          $CHANNEL = "${{ steps.version.outputs.CHANNEL }}"
          $binaryPath = "src-tauri/target/${{ matrix.target }}/release/kiro-token-manager.exe"
          $PREFIX = if ($CHANNEL -eq "default") { "" } else { "${CHANNEL}_" }
          
          New-Item -ItemType Directory -Force -Path "portable"
          
          # åˆ›å»ºä¾¿æºç‰ˆï¼ˆä¸å« WebView2ï¼‰
          $portableDir = "portable/${PREFIX}KiroTokenManager_${VERSION}_x64_portable"
          New-Item -ItemType Directory -Force -Path $portableDir
          Copy-Item $binaryPath "$portableDir/KiroTokenManager.exe"
          New-Item -ItemType File -Path "$portableDir/.portable" -Force
          Compress-Archive -Path $portableDir -DestinationPath "portable/${PREFIX}KiroTokenManager_${VERSION}_x64_portable.zip"

      - name: Prepare release files
        shell: bash
        run: |
          mkdir -p release
          VERSION=${{ steps.version.outputs.VERSION }}
          CHANNEL=${{ steps.version.outputs.CHANNEL }}
          TARGET=${{ matrix.target }}
          ARCH=${{ matrix.arch }}
          
          if [ "$CHANNEL" = "default" ]; then
            PREFIX=""
          else
            PREFIX="${CHANNEL}_"
          fi
          
          echo "ðŸ“¦ Channel: $CHANNEL, Version: $VERSION, Prefix: $PREFIX"
          
          if [ "${{ matrix.platform }}" = "windows-latest" ]; then
            for f in portable/*.zip; do
              [ -f "$f" ] && cp "$f" "release/"
            done
          fi
          
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            for f in src-tauri/target/${TARGET}/release/bundle/dmg/*.dmg; do
              [ -f "$f" ] && cp "$f" "release/${PREFIX}KiroTokenManager_${VERSION}_${ARCH}.dmg"
            done
          fi
          
          if [ "${{ matrix.platform }}" = "ubuntu-22.04" ]; then
            for f in src-tauri/target/${TARGET}/release/bundle/deb/*.deb; do
              [ -f "$f" ] && cp "$f" "release/${PREFIX}KiroTokenManager_${VERSION}_${ARCH}.deb"
            done
            for f in src-tauri/target/${TARGET}/release/bundle/rpm/*.rpm; do
              [ -f "$f" ] && cp "$f" "release/${PREFIX}KiroTokenManager_${VERSION}_x86_64.rpm"
            done
          fi
          
          cd release
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            shasum -a 256 * > SHA256SUMS.txt 2>/dev/null || true
          else
            sha256sum * > SHA256SUMS.txt 2>/dev/null || true
          fi
          cd ..
          ls -lh release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ steps.version.outputs.CHANNEL }}-${{ matrix.target }}
          path: release/*
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
